<!-- ─── public/index.html ───────────────────────────────────────────────────── -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1.0" />
  <title>PatternTrader Pro</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    /* ─── YOUR FULL CSS (unchanged) ───────────────────────────────────────── */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family:'Segoe UI',sans-serif; background:#000; color:#333; overflow-x:hidden; }
    header{display:flex;justify-content:space-between;padding:1rem;background:#1f2937;color:#fff;}
    footer{text-align:center;padding:1rem;color:#777;}
    #side-menu{position:fixed;top:0;left:-260px;width:260px;height:100%;background:#000;
      box-shadow:4px 0 15px rgba(16,185,129,0.6);color:#d1d5db;transition:left .35s;
      padding:1.5rem;z-index:1000;display:flex;flex-direction:column;gap:1rem;}
    #side-menu.open{left:0;}
    #side-menu .close-btn{align-self:flex-end;background:transparent;border:none;
      color:#10b981;font-size:1.5rem;cursor:pointer;margin-bottom:1rem;font-weight:700;}
    #side-menu .close-btn:hover{color:#34d399;text-shadow:0 0 8px #34d399;}
    #side-menu button{width:100%;background:#0f172a;border:2px solid #000;color:#fff;
      padding:.75rem 1rem;font-size:1.1rem;border-radius:8px;cursor:pointer;font-weight:600;
      box-shadow:0 0 8px #1021b944;transition:all .3s;}
    #side-menu button:hover{background:#7510b9;color:#0f172a;
      box-shadow:0 0 10px #3510b9,0 0 30px #00e1ff,0 0 40px #104bb9;transform:scale(1.05);}
    .hamburger{cursor:pointer;width:30px;height:24px;display:flex;flex-direction:column;justify-content:space-between;}
    .hamburger div{height:4px;background:#fff;border-radius:2px;}
    main{display:grid;grid-template-columns:auto 3fr 1fr;gap:1rem;max-width:1400px;margin:2rem auto;}
    .card{background:#fff;border-radius:8px;padding:1rem;}
    .chart-wrapper{position:relative;height:400px;margin-bottom:1rem;overflow:hidden;}
    #d3-chart{width:100%;height:100%;display:block;}
    .line{stroke:#007acc;fill:none;stroke-width:2;filter:drop-shadow(0 0 6px rgba(0,122,204,0.8));}
    .pin{position:absolute;top:0;left:0;width:100%;height:2px;background:#000;
      box-shadow:0 0 10px #0400ff,0 0 20px #0037ff;animation:glowLine 1.2s infinite alternate;
      pointer-events:none;transform:translateY(-1px);}
    @keyframes glowLine{0%{opacity:1;box-shadow:0 0 8px #0077ff,0 0 16px #0077ff;}
      50%{opacity:.7;box-shadow:0 0 16px #0077ff,0 0 24px #0077ff;}100%{opacity:1;
      box-shadow:0 0 8px #0077ff,0 0 16px #0077ff;}}
    .controls{display:flex;flex-wrap:wrap;align-items:center;gap:1rem;margin-top:1rem;}
    input[type=number],button{padding:.5rem;border-radius:4px;border:1px solid #ccc;}
    .buy,.sell{padding:1rem 2rem;font-size:1rem;font-weight:bold;border:none;border-radius:6px;cursor:pointer;transition:all .3s;}
    .buy{background:#10b981;color:#000;} .buy:hover{box-shadow:0 0 10px #10b981;transform:scale(1.05);}
    .sell{background:#ef4444;color:#fff;} .sell:hover{box-shadow:0 0 10px #ef4444;transform:scale(1.05);}
    .stats{display:flex;justify-content:space-between;margin-top:1rem;}
    .stat{background:#f9fafb;padding:.75rem;border-radius:4px;flex:1;text-align:center;margin:0 .25rem;}
    .trades-log ul{list-style:none;padding:0;max-height:200px;overflow-y:auto;}
    .trades-log li{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid #eee;}
    .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:rgba(0,0,0,.85);color:#fff;padding:1rem 1.5rem;border-radius:6px;
      font-size:1.2rem;opacity:0;pointer-events:none;transition:opacity .3s;z-index:1001;}
    .popup.show{opacity:1;}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);
      display:none;justify-content:center;align-items:center;z-index:999;}
    .modal-overlay.show{display:flex;}
    .modal{background:#fff;padding:1.5rem;border-radius:8px;width:90%;max-width:400px;text-align:center;}
    .modal h3{margin-bottom:1rem;}
    .modal .presets{display:flex;justify-content:space-around;margin-bottom:1rem;}
    .modal .presets button{flex:1;margin:0 .25rem;padding:.5rem;}
    .modal input[type=number]{width:calc(100% - 2rem);margin-bottom:1rem;}
    .modal-buttons{display:flex;justify-content:space-around;}
    .btn-loading{border:4px solid #f3f3f3;border-top:4px solid #28a745;border-radius:50%;
      width:24px;height:24px;animation:spin 1s linear infinite;display:inline-block;margin-left:.5rem;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .actions{display:none;flex-direction:column;gap:1rem;}
  </style>
</head>
<body>
  <header>
    <div class="hamburger" onclick="toggleMenu()">
      <div></div><div></div><div></div>
    </div>
    <h1>PatternTrader Pro</h1>
    <div>Balance: $<span id="balance">0.00</span></div>
  </header>

  <div id="side-menu">
    <button class="close-btn" title="Close menu" onclick="toggleMenu()">×</button>
    <button onclick="deposit()">Deposit</button>
    <button onclick="withdraw()">Withdraw</button>
    <button onclick="triggerReset()">Reset</button>
  </div>

  <main>
    <div class="actions"></div>
    <div class="card">
      <h2>Live Pattern Chart</h2>
      <div class="chart-wrapper"><svg id="d3-chart"></svg></div>
      <div class="controls">
        <label for="trade-amount">Amount ($):</label>
        <input type="number" id="trade-amount" min="1" value="100">
        <button class="buy"  onclick="placeTrade('buy')">Buy</button>
        <button class="sell" onclick="placeTrade('sell')">Sell</button>
      </div>
    </div>
    <div class="card">
      <h2>Stats & Trades</h2>
      <div class="stats">
        <div class="stat"><div>Traders</div><div id="traders-count">0</div></div>
        <div class="stat"><div>Buys   </div><div id="buy-count">0</div></div>
        <div class="stat"><div>Sells  </div><div id="sell-count">0</div></div>
      </div>
      <div class="trades-log">
        <h3>Trade History</h3>
        <ul id="trades-list"></ul>
      </div>
    </div>
  </main>

  <footer>&copy; <span id="year"></span> PatternTrader Pro</footer>
  <div class="popup" id="popup"></div>
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal-content"></div>
  </div>

<script>
  // ─── MENU & MODAL HELPERS ────────────────────────────────────────────────────
  function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }
  function showModal(html) {
    document.getElementById('modal-content').innerHTML = html;
    document.getElementById('modal-overlay').classList.add('show');
  }
  function hideModal() { document.getElementById('modal-overlay').classList.remove('show'); }
  function showPopup(msg) {
    const p = document.getElementById('popup');
    p.textContent = msg; p.classList.add('show');
    setTimeout(() => p.classList.remove('show'), 3000);
  }
  function showLoading(msg) {
    const p = document.getElementById('popup');
    p.textContent = msg; p.classList.add('show');
    const spinner = document.createElement('span');
    spinner.className = 'btn-loading';
    p.appendChild(spinner);
    setTimeout(() => p.classList.remove('show'), 3000);
  }

  // ─── DEPOSIT / WITHDRAW / RESET ─────────────────────────────────────────────
  function triggerReset(){
    showModal(`
      <h3>Are you sure?</h3>
      <div class="modal-buttons">
        <button onclick="confirmReset()">Yes, reset</button>
        <button onclick="hideModal()">Cancel</button>
      </div>`);
  }
  function confirmReset(){
    hideModal();
    localStorage.clear();
    location.reload();
  }
  function deposit(){
    showModal(`
      <h3>Deposit Funds</h3>
      <input type="number" id="deposit-input" placeholder="Amount (min $10)" min="10">
      <div class="modal-buttons">
        <button onclick="processDeposit()">Done</button>
        <button onclick="hideModal()">Cancel</button>
      </div>`);
  }
  async function processDeposit(){
    const v=+document.getElementById('deposit-input').value;
    if(isNaN(v)||v<10) return alert("Min $10");
    hideModal(); showLoading("Depositing...");
    await new Promise(r=>setTimeout(r,2000));
    state.balance+=v; save(); updateUI(); showPopup(`Deposited $${v}`);
  }
  function withdraw(){
    showModal(`
      <h3>Withdraw Funds</h3>
      <input type="number" id="withdraw-input" placeholder="Amount (min $10)" min="10">
      <div class="modal-buttons">
        <button onclick="processWithdraw()">Done</button>
        <button onclick="hideModal()">Cancel</button>
      </div>`);
  }
  async function processWithdraw(){
    const v=+document.getElementById('withdraw-input').value;
    if(isNaN(v)||v<10||v>state.balance) return alert("Invalid");
    hideModal(); showLoading("Withdrawing...");
    await new Promise(r=>setTimeout(r,2000));
    state.balance-=v; save(); updateUI(); showPopup(`Withdrew $${v}`);
  }

  // ─── INITIAL STATE & STORAGE ─────────────────────────────────────────────────
  const STORAGE_KEY = "pt_state";
  const CHART_KEY   = "pt_chart_data";
  let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    balance: 1000,
    trades: []
  };
  let data = JSON.parse(localStorage.getItem(CHART_KEY)) || [];

  // ─── DOM REFS ────────────────────────────────────────────────────────────────
  const balanceEl   = document.getElementById('balance');
  const tradersEl   = document.getElementById('traders-count');
  const buyCountEl  = document.getElementById('buy-count');
  const sellCountEl = document.getElementById('sell-count');
  const tradesList  = document.getElementById('trades-list');
  document.getElementById('year').textContent = new Date().getFullYear();

  // ─── D3 CHART SETUP ─────────────────────────────────────────────────────────
  const svg     = d3.select('#d3-chart');
  const wrapper = document.querySelector('.chart-wrapper');
  const margin  = { top:20,right:20,bottom:30,left:40 };
  let W = wrapper.clientWidth - margin.left - margin.right;
  let H = wrapper.clientHeight - margin.top - margin.bottom;

  svg.attr("viewBox",`0 0 ${W+margin.left+margin.right} ${H+margin.top+margin.bottom}`);
  const g  = svg.append("g").attr("transform",`translate(${margin.left},${margin.top})`);
  const x  = d3.scaleTime().range([0,W]);
  const y  = d3.scaleLinear().range([H,0]);
  const line = d3.line()
    .x(d=>x(d.time))
    .y(d=>y(d.price))
    .curve(d3.curveMonotoneX);

  const path = g.append("path").datum(data).attr("class","line");
  g.append("g").attr("class","x axis").attr("transform",`translate(0,${H})`);
  g.append("g").attr("class","y axis");

  function updateScales(){
    x.domain(d3.extent(data,d=>d.time));
    y.domain([
      d3.min(data,d=>d.price)*0.998,
      d3.max(data,d=>d.price)*1.002
    ]);
  }
  function draw(){
    path.datum(data).attr("d",line);
    g.select(".x.axis").call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat("%H:%M:%S")));
    g.select(".y.axis").call(d3.axisLeft(y));
  }

  // ─── SOCKET.IO REAL‐TIME ──────────────────────────────────────────────────────
  const socket = io({ path:"/socketServer" });
  let globalStats = {};

  socket.on("init", gs => {
    globalStats = gs;
    data = gs.data;
    updateScales(); draw(); updateUI();
  });
  socket.on("tick", gs => {
    globalStats = gs; data = gs.data;
    updateScales(); draw(); updateUI(); save();
  });
  socket.on("stats", stats => {
    globalStats = { ...globalStats, ...stats };
    updateUI(); save();
  });

  // ─── MARKET SIMULATION & TICK ───────────────────────────────────────────────
  let buyImpact=0, sellImpact=0;
  function isMarketOpen(){
    const now=new Date(), d=now.getDay(), h=now.getHours(), m=now.getMinutes();
    return !(d===0||(h===2&&m>=30)||(h>2&&h<5));
  }
  function tick(){
    if(!isMarketOpen()) return;
    const last = data.length?data[data.length-1].price:state.balance?state.balance:1.2;
    const pressure = (buyImpact - sellImpact)*0.0002;
    const rf = (Math.random()-0.5)*0.0015;
    const next = last*(1 + rf + pressure);
    const now = Date.now();
    const price = +next.toFixed(5);
    data.push({ time: now, price });
    data.shift();
    state.price = price;
    state.traders = (state.traders||0) + Math.floor(Math.random()*2);
    buyImpact *= .9; sellImpact *= .9;
    socket.emit("tick",{ data, traders: state.traders });
  }
  setInterval(tick,1000);

  // ─── PLACE TRADE ─────────────────────────────────────────────────────────────
  function placeTrade(type){
    const amt = +document.getElementById('trade-amount').value;
    if(amt<=0||amt>state.balance) return alert("Invalid amount");
    state.balance -= amt;
    if(type==="buy") buyImpact += amt/1000;
    else              sellImpact+= amt/1000;

    const entryPrice = state.price, entryTime = Date.now();
    const pin = document.createElement('div');
    pin.className='pin';
    const px = x(entryTime)+margin.left, py = y(entryPrice)+margin.top;
    pin.style.left=`${px}px`; pin.style.top=`${py}px`;
    wrapper.appendChild(pin);

    setTimeout(()=>{
      const exitPrice = state.price;
      const pipValue = 0.0001;
      const pipDiff  = (exitPrice-entryPrice);
      const pips     = (type==="buy"?pipDiff:-pipDiff)/pipValue;
      const pnl      = pips*pipValue*amt;
      if(pnl>0) state.balance += amt + pnl;
      state.trades.push({ type, entry:entryPrice, exit:exitPrice, pnl, time:Date.now() });
      showPopup((pnl>=0?"Profit: +":"Loss: ")+`$${pnl.toFixed(2)}`);
      pin.remove();
      save(); updateUI();
    },10000);

    socket.emit("trade",{ type });
    save(); updateUI();
  }

  // ─── UI UPDATE & SAVE ────────────────────────────────────────────────────────
  function updateUI(){
    balanceEl.textContent = state.balance.toFixed(2);
    tradersEl.textContent = globalStats.traders||0;
    buyCountEl.textContent= globalStats.buys||0;
    sellCountEl.textContent=globalStats.sells||0;
    tradesList.innerHTML = "";
    (state.trades||[]).slice(-15).reverse().forEach(t=>{
      const li=document.createElement("li");
      li.innerHTML = `<span>${new Date(t.time).toLocaleTimeString()} ${t.type.toUpperCase()}</span>
                      <span>${t.pnl>=0?"+":""}${t.pnl.toFixed(2)}</span>`;
      tradesList.appendChild(li);
    });
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    localStorage.setItem(CHART_KEY,   JSON.stringify(data));
  }

  // ─── INITIAL DRAW ────────────────────────────────────────────────────────────
  updateScales(); draw(); updateUI();
</script>
</body>
</html>
