<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PatternTrader Pro</title>
  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Reset & Base */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #000; color: #333; overflow-x: hidden; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #1f2937; color: #fff; }
    footer { text-align: center; padding: 1rem; color: #777; }
    main {
      display: grid;
      grid-template-columns: auto 3fr 1fr;
      gap: 1rem;
      max-width: 1400px;
      margin: 2rem auto;
      transition: margin-left 0.3s;
    }

    /* Hamburger */
    #hamburger {
      font-size: 1.5rem;
      cursor: pointer;
      margin-right: 1rem;
    }

    /* Side Panel */
    .side-panel {
      position: fixed;
      top: 0; left: -250px;
      width: 250px; height: 100%;
      background: #111; color: #eee;
      display: flex; flex-direction: column; padding: 2rem 1rem;
      gap: 1rem; transition: left 0.3s;
      z-index: 1000;
    }
    .side-panel.open { left: 0; }
    .side-panel .user-info { font-weight: bold; }
    .side-panel button {
      background: #3b82f6; border: none; color: #fff;
      padding: .75rem; border-radius: 4px; cursor: pointer;
      text-align: left;
    }
    .side-panel button:hover { background: #2563eb; }

    /* Cards */
    .card { background: #fff; border-radius: 8px; padding: 1rem; }
    .chart-wrapper { position: relative; height: 400px; margin-bottom: 1rem; overflow: hidden; }
    #d3-chart { width: 100%; height: 100%; display: block; }
    .line { stroke: #007acc; fill: none; stroke-width: 2; filter: drop-shadow(0 0 6px rgba(0,122,204,0.8)); }

    /* Pin */
    .pin { position: absolute; width: 12px; height: 12px; background: #ff0; border-radius: 50%; box-shadow: 0 0 8px #ff0; animation: pulse 1s ease-out infinite; pointer-events: none; }
    @keyframes pulse {
      0%   { transform: translate(-6px, -6px) scale(1); opacity: 1; }
      50%  { transform: translate(-6px, -6px) scale(1.4); opacity: 0.6; }
      100% { transform: translate(-6px, -6px) scale(1); opacity: 1; }
    }

    /* Controls */
    .controls { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; margin-top: 1rem; }
    input[type=number], button { padding: .5rem; border-radius: 4px; border: 1px solid #ccc; }
    .buy, .sell { padding: 1rem 2rem; font-size: 1rem; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; transition: transform .2s; }
    .buy { background: #10b981; color: #fff; } .sell { background: #ef4444; color: #fff; }
    .buy:hover { transform: scale(1.05); } .sell:hover { transform: scale(1.05); }

    /* Stats */
    .stats { display: flex; justify-content: space-between; margin-top: 1rem; }
    .stat { background: #f9fafb; padding: .75rem; border-radius: 4px; flex: 1; text-align: center; margin: 0 .25rem; }

    /* Trade log */
    .trades-log ul { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
    .trades-log li { display: flex; justify-content: space-between; padding: .5rem 0; border-bottom: 1px solid #eee; }

    /* Popup */
    .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: #fff; padding: 1rem 1.5rem; border-radius: 6px; font-size: 1.2rem; opacity: 0; pointer-events: none; transition: opacity .3s; }
    .popup.show { opacity: 1; }

    /* Tutorial overlay */
    .tutorial-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: #fff; display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 999; padding: 2rem; text-align: center; }
    .tutorial-overlay.active { display: flex; }
    .tutorial-controls { margin-top: 2rem; }
    .tutorial-controls button { margin: 0 .5rem; padding: .75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; }
    .tutorial-controls .next { background: #10b981; color: #fff; }
    .tutorial-controls .skip { position: absolute; top: 1rem; right: 1rem; background: #dc2626; color: #fff; }
  </style>
</head>
<body>
  <header>
    <div id="hamburger">&#9776;</div>
    <h1>PatternTrader Pro</h1>
    <div>Balance: $<span id="balance">0.00</span></div>
  </header>

  <div class="side-panel" id="sidePanel">
    <div class="user-info" id="userInfo">User (ID)</div>
    <button onclick="panel('deposit')">Deposit</button>
    <button onclick="panel('withdraw')">Withdraw</button>
    <button onclick="panel('reset')">Reset</button>
    <button onclick="logout()">Log Out</button>
  </div>

  <main id="mainContent">
    <!-- Chart Panel -->
    <div class="card">
      <h2>Live Pattern Chart</h2>
      <div class="chart-wrapper"><svg id="d3-chart"></svg></div>
      <div class="controls">
        <label>Amount ($):<input type="number" id="trade-amount" min="1" value="1"></label>
        <button class="buy" onclick="placeTrade('buy')">Buy</button>
        <button class="sell" onclick="placeTrade('sell')">Sell</button>
      </div>
    </div>
    <!-- Stats Panel -->
    <div class="card">
      <h2>Stats & Trades</h2>
      <div class="stats">
        <div class="stat"><div>Traders</div><div id="traders-count">0</div></div>
        <div class="stat"><div>Buys</div><div id="buy-count">0</div></div>
        <div class="stat"><div>Sells</div><div id="sell-count">0</div></div>
      </div>
      <div class="trades-log"><h3>Trade History</h3><ul id="trades-list"></ul></div>
    </div>
  </main>

  <footer>&copy; <span id="year"></span> PatternTrader Pro</footer>
  <div class="popup" id="popup"></div>
  <div class="tutorial-overlay" id="tutorial">
    <div id="tut-step"></div>
    <div class="tutorial-controls">
      <button class="skip" onclick="endTutorial()">Skip</button>
      <button class="next" onclick="nextTutorial()">Next</button>
    </div>
  </div>

  <script>
    // Hamburger toggle
    document.getElementById('hamburger').onclick = () => {
      document.getElementById('sidePanel').classList.toggle('open');
    };

    // --- User & State Initialization ---
    let users = JSON.parse(localStorage.getItem('pt_users') || '[]'),
        cur   = localStorage.getItem('pt_current'),
        me    = users.find(u => u.email === cur) || { username: 'User', id: '?', state:{ balance:1000, tradeAmt:1, traders:0, buys:0, sells:0, trades:[] }, tutShown:false };

    document.getElementById('userInfo').textContent = `${me.username} (ID:${me.id})`;
    let state = me.state;
    document.getElementById('trade-amount').value = state.tradeAmt;

    document.getElementById('year').textContent = new Date().getFullYear();

    // UI Refs
    const balanceEl   = document.getElementById('balance'),
          tradersEl   = document.getElementById('traders-count'),
          buyCountEl  = document.getElementById('buy-count'),
          sellCountEl = document.getElementById('sell-count'),
          tradesList  = document.getElementById('trades-list'),
          popup       = document.getElementById('popup');

    // --- D3 Chart Setup ---
    const svg     = d3.select('#d3-chart'),
          wrapper = document.querySelector('.chart-wrapper');
    const margin  = { top:20, right:20, bottom:30, left:40 },
          W       = wrapper.clientWidth - margin.left - margin.right,
          H       = wrapper.clientHeight - margin.top - margin.bottom;
    let data = JSON.parse(localStorage.getItem('pt_chart_data')) ||
               d3.range(60).map((_,i) => ({ time: Date.now() - (60-i)*1000, price: state.price }));

    svg.attr('viewBox', `0 0 ${W+margin.left+margin.right} ${H+margin.top+margin.bottom}`);
    const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);
    const x = d3.scaleTime().range([0,W]), y = d3.scaleLinear().range([H,0]);
    const line = d3.line().curve(d3.curveMonotoneX).x(d=>x(d.time)).y(d=>y(d.price));
    g.append('path').datum(data).attr('class','line');
    g.append('g').attr('class','x axis').attr('transform', `translate(0,${H})`);
    g.append('g').attr('class','y axis');
    function updateScales(){ x.domain(d3.extent(data,d=>d.time)); y.domain([d3.min(data,d=>d.price)*.998, d3.max(data,d=>d.price)*1.002]); }
    function draw(){ g.select('.line').attr('d',line); g.select('.x.axis').call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat('%H:%M:%S'))); g.select('.y.axis').call(d3.axisLeft(y)); }

    // --- Simulated Tick ---
    setInterval(tick,1000);
    function tick(){
      let last = data[data.length-1].price,
          nxt  = last*(1+(Math.random()-0.5)*.0015);
      state.price = +nxt.toFixed(5);
      state.traders++;
      data.push({ time: Date.now(), price: state.price });
      data.shift();
      updateScales(); draw(); updateUI(); save();
      localStorage.setItem('pt_chart_data', JSON.stringify(data));
    }

    // --- UI Update & Persistence ---
    function updateUI(){
      balanceEl.textContent = state.balance.toFixed(2);
      tradersEl.textContent = state.traders;
      buyCountEl.textContent = state.buys;
      sellCountEl.textContent = state.sells;
      tradesList.innerHTML = '';
      (state.trades||[]).slice(0,15).forEach(t=>{
        let li = document.createElement('li');
        li.innerHTML = `<span>${new Date(t.time).toLocaleTimeString()} ${t.type.toUpperCase()}</span><span>${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}</span>`;
        tradesList.appendChild(li);
      });
    }
    function save(){
      me.state = state;
      users = users.map(u => u.email===me.email ? me : u);
      localStorage.setItem('pt_users', JSON.stringify(users));
    }

    // --- Side-Panel Actions ---
    function panel(type){
      let amt = (type==='reset') ? 0 : parseFloat(prompt(`Enter amount to ${type}:`));
      if(type!=='reset' && (!amt || amt<=0)) return alert('Invalid amount.');
      if(type==='deposit') state.balance += amt;
      if(type==='withdraw' && amt<=state.balance) state.balance -= amt;
      if(type==='reset'){ state.balance=1000; state.buys=0; state.sells=0; state.trades=[]; }
      save(); updateUI();
    }
    function logout(){
      localStorage.removeItem('pt_current');
      location.href = 'login.html';
    }

    // --- Trade Logic ---
    function placeTrade(type){
      let amt = parseFloat(document.getElementById('trade-amount').value);
      if(!amt || amt>state.balance) return alert('Invalid trade amount.');
      state.balance -= amt;
      state[type==='buy'?'buys':'sells']++;
      let entry = state.price, t0 = Date.now();
      let pin = document.createElement('div'); pin.className='pin';
      pin.style.left = x(t0)+margin.left+'px';
      pin.style.top  = y(entry)+margin.top+'px';
      wrapper.appendChild(pin);
      setTimeout(()=>{
        let exit = state.price, pip=0.0001, diff=exit-entry, pips=(type==='buy'?diff:-diff)/pip, pnl=pips*pip*amt;
        if(pnl>0) state.balance += amt + pnl;
        state.trades.unshift({ time: Date.now(), type, amt, pnl });
        if(state.trades.length>50) state.trades.pop();
        showPopup((pnl>=0?'+':'')+pnl.toFixed(2));
        pin.remove(); save(); updateUI();
      },10000);
      save(); updateUI();
    }

    // --- Popup ---
    function showPopup(msg){
      popup.textContent=msg; popup.classList.add('show');
      setTimeout(()=>popup.classList.remove('show'),3000);
    }

    // --- Tutorial (first-time only) ---
    const steps = [
      'Welcome to PatternTrader Pro!',
      'This is your live pattern chart.',
      'Use the side panel to Deposit, Withdraw, Reset, or Logout.',
      'Set your trade amount and click Buy or Sell.',
      'See your stats & trade history update below.',
      'Tutorial complete—happy trading!'
    ];
    let step=0, tut=document.getElementById('tutorial'), ts=document.getElementById('tut-step');
    function nextTutorial(){
      if(step>=steps.length-1) return endTutorial();
      step++; ts.textContent=steps[step];
    }
    function endTutorial(){
      tut.classList.remove('active');
      me.tutShown = true; save();
    }
    window.onload = () => {
      if(!me.tutShown){
        tut.classList.add('active');
        ts.textContent = steps[0];
      }
      updateScales(); draw(); updateUI();
    };
  </script>
</body>
</html>
