<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PatternTrader Pro</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #000; color: #333; overflow-x: hidden; }
    header { display: flex; justify-content: center; align-items: center; padding: 1rem; background: #1f2937; color: #fff; }
    footer { text-align: center; padding: 1rem; color: #777; }

    /* Layout */
    main { display: grid; grid-template-columns: 1fr 3fr 1fr; gap: 1rem; max-width: 1400px; margin: 2rem auto; }
    .card { background: #fff; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    .chart-wrapper { position: relative; height: 400px; overflow: hidden; }
    #d3-chart { width: 100%; height: 100%; display: block; }
    .line { stroke: #007acc; fill: none; stroke-width: 2; filter: drop-shadow(0 0 6px rgba(0,122,204,0.8)); }

    /* Control panel */
    .actions { display: flex; flex-direction: column; gap: 1rem; }
    .control-panel h2 { margin-bottom: 0.5rem; }
    .control-panel button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      margin-bottom: 0.5rem;
    }
    .control-panel button:hover { transform: scale(1.02); }
    .btn-buy-impact { background: #10b981; color: #fff; }
    .btn-sell-impact { background: #ef4444; color: #fff; }
    .btn-reset-impact { background: #6b7280; color: #fff; }

    .impact-range { display: flex; flex-direction: column; gap: 0.25rem; }
    .impact-range label { font-size: 0.9rem; }

  </style>
</head>
<body>

  <header>
    <h1>PatternTrader Pro</h1>
  </header>

  <main>
    <!-- Control Panel Column -->
    <div class="actions card control-panel">
      <h2>Control Panel</h2>
      <button class="btn-buy-impact" onclick="forceBuyImpact()">Force Buy Impact</button>
      <button class="btn-sell-impact" onclick="forceSellImpact()">Force Sell Impact</button>
      <button class="btn-reset-impact" onclick="resetImpacts()">Reset Impacts</button>
      <div class="impact-range">
        <label>Impact Strength: <span id="impact-strength-label">1.0</span></label>
        <input type="range" id="impact-strength" min="0.1" max="5" step="0.1" value="1.0" oninput="updateImpactStrength(this.value)">
      </div>
    </div>

    <!-- Chart Column -->
    <div class="card">
      <h2>Live Pattern Chart</h2>
      <div class="chart-wrapper"><svg id="d3-chart"></svg></div>
    </div>

    <!-- Empty right column -->
    <div></div>
  </main>

  <footer>&copy; <span id="year"></span> PatternTrader Pro</footer>

  <!-- Socket.IO client -->
  <script src="server.js"></script>
  <script>
    const socket = io({ transports:['websocket','polling'], reconnection:true });
    socket.on('connect', () => console.log('Connected:', socket.id));
    socket.on('disconnect', reason => console.log('Disconnected:', reason));
    socket.on('tick', msg => {
      const now = Date.now();
      data.push({ time: now, price: msg.price });
      data.shift();
      updateScales(); draw(); save();
    });
  </script>

  <script>
    // Persistence keys
    const CHART_KEY = "pt_chart_data";

    // Impact globals
    let buyImpact = 0, sellImpact = 0, impactStrength = 1.0;

    // DOM refs
    const yearEl = document.getElementById('year'),
          impactLabel = document.getElementById('impact-strength-label');
    yearEl.textContent = new Date().getFullYear();

    // D3 setup
    const svg = d3.select('#d3-chart');
    const wrapper = document.querySelector('.chart-wrapper');
    const margin = { top:20, right:20, bottom:30, left:40 };
    let W = wrapper.clientWidth - margin.left - margin.right;
    let H = wrapper.clientHeight - margin.top - margin.bottom;

    // Rebuild or initialize data
    const raw = JSON.parse(localStorage.getItem(CHART_KEY) || 'null');
    let data = Array.isArray(raw) && raw.length
      ? raw.map((d,i)=>({ time: Date.now() - ((raw.length-i)*1000), price: d.price }))
      : d3.range(60).map((_,i)=>({ time: Date.now() - ((60-i)*1000), price: 1.2 }));

    svg.attr("viewBox", `0 0 ${W+margin.left+margin.right} ${H+margin.top+margin.bottom}`);
    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
    const x = d3.scaleTime().range([0,W]);
    const y = d3.scaleLinear().range([H,0]);
    const line = d3.line().x(d=>x(d.time)).y(d=>y(d.price)).curve(d3.curveMonotoneX);
    const path = g.append("path").datum(data).attr("class","line");
    g.append("g").attr("class","x axis").attr("transform", `translate(0,${H})`);
    g.append("g").attr("class","y axis");

    function updateScales(){
      x.domain(d3.extent(data, d=>d.time));
      y.domain([d3.min(data,d=>d.price)*0.998, d3.max(data,d=>d.price)*1.002]);
    }

    function draw(){
      path.datum(data).attr("d", line);
      g.select(".x.axis").call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat("%H:%M:%S")));
      g.select(".y.axis").call(d3.axisLeft(y));
    }

    function save(){
      localStorage.setItem(CHART_KEY, JSON.stringify(data));
    }

    // Simulate ticks locally if needed
    function tick(){
      const last = data[data.length-1].price;
      const pressure = (buyImpact - sellImpact) * 0.0002 * impactStrength;
      const randomFactor = (Math.random() - 0.5) * 0.0015;
      const next = last * (1 + randomFactor + pressure);
      data.push({ time: Date.now(), price: +next.toFixed(5) });
      data.shift();
      buyImpact *= 0.9; sellImpact *= 0.9;
      updateScales(); draw(); save();
    }
    setInterval(tick, 1000);

    // Control panel actions
    function forceBuyImpact(){ buyImpact += 1 * impactStrength; }
    function forceSellImpact(){ sellImpact += 1 * impactStrength; }
    function resetImpacts(){ buyImpact = 0; sellImpact = 0; }
    function updateImpactStrength(val){
      impactStrength = +val;
      impactLabel.textContent = impactStrength.toFixed(1);
    }

    // Initial render
    updateScales(); draw(); save();
  </script>
</body>
</html>
